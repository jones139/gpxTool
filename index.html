<html>
<head>
<title>GPX Route Editor</title>
<link rel="stylesheet" href="leaflet/leaflet.css" />
<!--[if IE]>  
<link rel="stylesheet" href="leaflet/leaflet.ie.css" />
<![endif]-->
<link rel="stylesheet" href="gpxedit.css" />
</head>
<body>
  <div id="mainContainer">
    <div id="map">
    </div> 
    <div id="routePtsDiv">
      <h2>Route Points</h2>
      <ol id="routePtsOl">
      </ol>
    </div>
  </div>
  <div id="gpxDiv">
    <h2>GPX Output</h2>
    <textarea id="gpxText" cols=30 rows=10>gpx data will go here</textarea>
    <button id="downloadButton">Download GPX Data</button>
  </div>
  <div id="debug"></div>

  <div id="uploadGpxDiv">
    <form id='uploadGpxForm' 
	  method='POST' 
	  enctype='multipart/form-data' 
	  action='api/uploadFile.php'
	  target='upload_target'>
      File to upload: <input type=file name='file'><br>
      Notes about the file: <input type=text name='note'><br>
      <br>
      <input type=submit value='Upload File'>
    </form>
    <iframe id="upload_target" 
	    name="upload_target" 
	    src="" 
	    style="width:200;height:300;border:1px solid #fff;">
    </iframe>
    
  </div>

<!--hidden form to use to submit data for downloading-->
<form hidden=true id='uploadForm' method='POST' enctype='multipart/form-data' action='api/downloadFile.php'>
<input type='textarea' id='formDataTextArea' name='file'> <br/>
</form>

<script src="jquery-1.6.4.min.js"></script>
<script src="leaflet/leaflet.js"></script>
<script src="leaflet-plugins/layer/vector/GPX.js"></script>

<script>
  // Upload Form handler


  ///////////////////////////////////////////////////
  // WaitForIFrame(): Checks the length of the iframe's contents.
  // Loops until contents length >26 (26 = length of empty head and body blocks).
  // NOTE: This is very crude - must be a better way than this!  Should at least
  // check that lenght has not changed for a while?
  // I did it this way because the changed() load() events were not being 
  // triggered for non-html data.
  // 02jun2012  GJ  ORIGINAL VERSION
  //
  function waitForIFrame() {
   var iframeContents = $("iframe").contents().find('html').html();
   jQuery("#debug").html(iframeContents.length + ":" + iframeContents+ "...");
   if (iframeContents.length <= 26) {
     setTimeout("waitForIFrame();", 1000);
   } else {
	setTimeout(function () {
        //var iframeContents = $("iframe").contents().find('html body').html();
        var gpxURL = "api/"+$("iframe").contents().find('html body a').attr('href');
	alert("done! - gpxURL="+gpxURL);
	var track = new L.GPX(gpxURL, {async: true});
	map.addLayer(track);
        track.on("loaded", function(e) { 
                            var retStr="";
                            var key;
                            for (key in e.target) {
                              retStr = retStr + key + ", ";
                            }
                            alert("loaded: "+e.type+": "+retStr);
                            map.fitBounds(e.target.getBounds()); 
                       }
         );

     },1000);
   }
 }

 $('#uploadGpxForm').submit(function() {
      waitForIFrame();
   });


</script>


<script src='routeEditor.js'></script>

</body>
</html>
